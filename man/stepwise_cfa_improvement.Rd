\name{stepwise_cfa_improvement}
\alias{stepwise_cfa_improvement}
\title{Stepwise CFA Improvement Through Modification Indices and Item Removal}
\description{
This function iteratively improves a Confirmatory Factor Analysis (CFA) model by combining two main procedures: (1) the removal of items with low factor loadings (absolute loadings below 0.30), and (2) the incorporation of error correlations with high modification indices (MI) that are logically acceptable based on the underlying factor structure. During the process, the function updates the CFA specification, re-estimates the model, and logs modifications until the scaled RMSEA meets the specified threshold or the maximum number of iterations is reached. An alternative model is also generated by removing items that appear excessively in error correlations.
}
\usage{
stepwise_cfa_improvement(initial_model, data, rmsea_threshold = 0.08, mi_threshold = 3.84, max_steps = 10, verbose = TRUE, debug = FALSE, filter_expr = NULL, ...)
}
\arguments{
  \item{initial_model}{A character string containing the initial CFA model specification. This specification should follow the lavaan model syntax.}
  \item{data}{A data frame that contains the data on which the CFA model will be estimated.}
  \item{rmsea_threshold}{A numeric value specifying the maximum allowed scaled RMSEA for the model to be considered acceptable (default is 0.08).}
  \item{mi_threshold}{A numeric value indicating the minimum modification index required to consider an error correlation for model improvement (default is 3.84).}
  \item{max_steps}{An integer defining the maximum number of iterations allowed for the improvement process (default is 10).}
  \item{verbose}{A logical value. If \code{TRUE}, informative messages are printed during each iteration of the process.}
  \item{debug}{A logical value. If \code{TRUE}, additional debugging information is printed.}
  \item{filter_expr}{An optional expression to filter the data prior to model estimation. If \code{NULL} no filtering is applied.}
  \item{...}{Additional arguments to be passed to the \code{lavaan::cfa} function.}
}
\details{
The \code{stepwise_cfa_improvement} function begins by optionally filtering the provided data and cleaning the initial CFA model specification. An initial CFA is then estimated using \code{lavaan::cfa}, and standardized loadings are examined to remove items with absolute loadings below 0.30. Subsequently, the function extracts an item-to-factor mapping from the CFA specification.

The iterative procedure then commences: in each iteration the current model is estimated and its scaled RMSEA is computed. If the RMSEA is below the specified \code{rmsea_threshold}, the procedure terminates. Otherwise, the function evaluates modification indices for error correlations (operator \code{"~~"}) using \code{lavaan::modificationIndices}, filtering out modifications that link items from different factors. The modification with the highest MI is selected and, if not already present, appended to the model specification. The updated model is then re-estimated, and items with low loadings are removed as necessary.

After the iterative process, the function checks whether any item appears in error correlations more than twice. If such offending items are detected, an alternative CFA model specification is generated by removing them, and the corresponding model fit is computed.

The process continues until an acceptable model is obtained or the maximum number of steps is reached.
}
\value{
A list containing the following components:
\item{final_model}{A character string with the final CFA model specification after all modifications.}
\item{final_fit}{The lavaan fit object corresponding to the final CFA model.}
\item{log}{A data frame logging each iteration, including the modification applied, the corresponding modification index value, and the RMSEA value at that step.}
\item{removed_items}{A character vector containing the names of items removed due to low factor loadings.}
\item{alternative_model}{If applicable, a character string with an alternative CFA model specification from which offending items (those appearing excessively in error correlations) have been removed; otherwise, \code{NA}.}
\item{alternative_fit}{The lavaan fit object corresponding to the alternative model, or \code{NA} if not applicable.}
\item{alternative_rmsea}{The RMSEA of the alternative model, or \code{NA} if no alternative model was computed.}
}
\examples{
# Example usage:
# Assume that 'model1' is a character string with the initial CFA specification
# and 'df_filtered1' is the data frame containing the observed variables.
result <- stepwise_cfa_improvement(
  initial_model    = model1,
  data             = df_filtered1,
  rmsea_threshold  = 0.08,
  mi_threshold     = 3.84,
  max_steps        = 10,
  verbose          = TRUE,
  debug            = FALSE,
  filter_expr      = NULL,
  estimator        = "WLSMV",
  mimic            = "Mplus",
  ordered          = TRUE
)

# The output 'result' is a list containing the final and alternative models,
# the lavaan fit objects, and a log of modifications.
}
\author{
Dr. José Ventura-León
}
